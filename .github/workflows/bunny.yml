name: bunny

on:
  # schedule:
  #   - cron: "0 0 * * *"
  workflow_dispatch:

# Prevent concurrent runs from interfering with each other
concurrency:
  group: bunny-workflow
  cancel-in-progress: false

jobs:
  fetch_data:
    runs-on: ubuntu-latest
    permissions:
      contents: write    # Required to push changes

    env:
      REPO_FOLDER: bunny-repo
      SCRIPT_NAME: bunny.py
      OUTPUT_FILE: bunny_credentials.json

    steps:
      - uses: actions/checkout@v5

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Clone target repo
        run: |
          git clone https://${{ secrets.SCRAPER_TOKEN }}@github.com/${{ secrets.BUNNY_REPO }} $REPO_FOLDER

      - name: Run script for all providers with retry logic
        run: |
          cd $REPO_FOLDER
          
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          
          # Detect default branch
          DEFAULT_BRANCH=$(git remote show origin | sed -n '/HEAD branch/s/.*: //p')
          
          providers=("tempmailplus" "tempmailplusio" "tmailor" "byom" "tempmail100" "yopmail" "tempmailorg")
          
          # Maximum retry attempts for push conflicts
          MAX_RETRIES=5
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "=== Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES ==="
            
            # Fetch latest remote state
            git fetch origin $DEFAULT_BRANCH
            
            # Reset to latest remote (ensures clean state)
            git reset --hard origin/$DEFAULT_BRANCH
            
            # Run script for all providers
            for provider in "${providers[@]}"; do
              echo "Running with provider: $provider"
              python $SCRIPT_NAME --provider $provider --number 2 || echo "Provider $provider failed, continuing..."
            done
            
            # Stage changes
            git add $OUTPUT_FILE
            
            # Check if there are any changes
            if git diff --cached --quiet; then
              echo "No changes to commit"
              exit 0
            fi
            
            # Commit all changes from this run
            git commit -m "Update $OUTPUT_FILE [bunny-$(date -u +%Y%m%d-%H%M%S)]"
            
            # Try to push
            if git push origin HEAD:$DEFAULT_BRANCH; then
              echo "✓ Successfully pushed changes"
              exit 0
            fi
            
            # Push failed, increment counter and retry
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              # Exponential backoff with jitter
              SLEEP_TIME=$((2 ** RETRY_COUNT + RANDOM % 5))
              echo "Push failed, waiting ${SLEEP_TIME}s before retry..."
              sleep $SLEEP_TIME
            fi
          done
          
          echo "✗ Failed to push after $MAX_RETRIES attempts"
          exit 1
